<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>ì´ë¯¸ì§€ â†’ WebP ë³€í™˜ ì„œë¹„ìŠ¤</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.5s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 10px;
        font-size: 2.5em;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      .upload-area {
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 60px 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        position: relative;
      }

      .upload-area:hover {
        border-color: #764ba2;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
      }

      .upload-area.dragover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
        border-color: #764ba2;
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 3em;
        color: #667eea;
        margin-bottom: 15px;
      }

      .upload-text {
        font-size: 1.2em;
        color: #555;
        margin-bottom: 10px;
        font-weight: 500;
      }

      input[type='file'] {
        display: none;
      }

      .quality-control {
        margin: 30px 0;
        padding: 20px;
        background: rgba(102, 126, 234, 0.05);
        border-radius: 10px;
        display: none;
      }

      .quality-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-weight: 500;
        color: #555;
      }

      .quality-value {
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: bold;
        font-size: 1.2em;
      }

      input[type='range'] {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(to right, #667eea, #764ba2);
        outline: none;
        -webkit-appearance: none;
      }

      input[type='range']::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .convert-btn {
        display: none;
        margin: 20px auto;
        padding: 15px 40px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1em;
        transition: all 0.3s;
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
      }

      .convert-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
      }

      .convert-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .image-item {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
        animation: popIn 0.5s ease;
      }

      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .image-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .image-preview {
        width: 100%;
        height: 180px;
        object-fit: cover;
        background: #f0f0f0;
      }

      .image-info {
        padding: 15px;
      }

      .image-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .image-sizes {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 10px;
        line-height: 1.5;
      }

      .size-reduction {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 0.85em;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .size-reduction.positive {
        background: linear-gradient(135deg, #52c234, #061700);
        color: white;
      }

      .size-reduction.negative {
        background: linear-gradient(135deg, #ff6b6b, #c92a2a);
        color: white;
      }

      .download-btn {
        width: 100%;
        padding: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .download-all-btn {
        display: none;
        margin: 30px auto;
        padding: 15px 40px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1em;
        transition: all 0.3s;
      }

      .download-all-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
      }

      .stats {
        display: none;
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        background: rgba(102, 126, 234, 0.05);
        border-radius: 10px;
      }

      .stat-item {
        display: inline-block;
        margin: 0 30px;
      }

      .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .stat-label {
        display: block;
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .spinner {
        display: inline-block;
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: #fee;
        color: #c00;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        display: none;
      }

      .success-message {
        background: #efe;
        color: #060;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¨ Image to WebP Converter</h1>
      <p class="subtitle">Node.js ê¸°ë°˜ ê³ ì„±ëŠ¥ ì´ë¯¸ì§€ ë³€í™˜ ì„œë¹„ìŠ¤</p>

      <div
        class="upload-area"
        id="uploadArea"
      >
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</div>
        <p style="color: #888; margin-top: 10px">JPG, PNG, GIF, BMP ì§€ì› (ìµœëŒ€ 20ê°œ, ê° 50MB)</p>
        <input
          type="file"
          id="fileInput"
          multiple
          accept="image/*"
        />
      </div>

      <div
        class="quality-control"
        id="qualityControl"
      >
        <div class="quality-label">
          <span>ë³€í™˜ í’ˆì§ˆ</span>
          <span
            class="quality-value"
            id="qualityValue"
            >85%</span
          >
        </div>
        <input
          type="range"
          id="qualitySlider"
          min="50"
          max="100"
          value="85"
          step="5"
        />
      </div>

      <button
        class="convert-btn"
        id="convertBtn"
        onclick="convertImages()"
      >
        ğŸš€ WebPë¡œ ë³€í™˜í•˜ê¸°
      </button>

      <div
        class="loading"
        id="loading"
      >
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #666">ì´ë¯¸ì§€ë¥¼ ë³€í™˜ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>

      <div
        class="error-message"
        id="errorMessage"
      ></div>
      <div
        class="success-message"
        id="successMessage"
      ></div>

      <div
        class="stats"
        id="stats"
      >
        <div class="stat-item">
          <span
            class="stat-value"
            id="totalFiles"
            >0</span
          >
          <span class="stat-label">ë³€í™˜ëœ íŒŒì¼</span>
        </div>
        <div class="stat-item">
          <span
            class="stat-value"
            id="totalOriginal"
            >0</span
          >
          <span class="stat-label">ì›ë³¸ í¬ê¸°</span>
        </div>
        <div class="stat-item">
          <span
            class="stat-value"
            id="totalConverted"
            >0</span
          >
          <span class="stat-label">ë³€í™˜ í›„ í¬ê¸°</span>
        </div>
        <div class="stat-item">
          <span
            class="stat-value"
            id="totalSaved"
            >0%</span
          >
          <span class="stat-label">í‰ê·  ì ˆê°ë¥ </span>
        </div>
      </div>

      <button
        class="download-all-btn"
        id="downloadAllBtn"
        onclick="downloadAll()"
      >
        ğŸ“¥ ëª¨ë“  íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ZIP)
      </button>

      <div
        class="image-grid"
        id="imageGrid"
      ></div>
    </div>

    <script>
      let selectedFiles = [];
      let convertedFiles = [];

      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      const imageGrid = document.getElementById('imageGrid');
      const qualityControl = document.getElementById('qualityControl');
      const qualitySlider = document.getElementById('qualitySlider');
      const qualityValue = document.getElementById('qualityValue');
      const convertBtn = document.getElementById('convertBtn');
      const loading = document.getElementById('loading');
      const stats = document.getElementById('stats');
      const downloadAllBtn = document.getElementById('downloadAllBtn');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');

      // íŒŒì¼ ì„ íƒ
      uploadArea.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });

      // ë“œë˜ê·¸ ì•¤ ë“œë¡­
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });

      // í’ˆì§ˆ ìŠ¬ë¼ì´ë”
      qualitySlider.addEventListener('input', (e) => {
        qualityValue.textContent = e.target.value + '%';
      });

      function handleFiles(files) {
        selectedFiles = Array.from(files).filter((file) => file.type.startsWith('image/'));

        if (selectedFiles.length > 0) {
          qualityControl.style.display = 'block';
          convertBtn.style.display = 'block';

          // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
          imageGrid.innerHTML = '';
          selectedFiles.forEach((file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const preview = document.createElement('div');
              preview.className = 'image-item';
              preview.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}" class="image-preview">
                            <div class="image-info">
                                <div class="image-name">${file.name}</div>
                                <div class="image-sizes">
                                    ì›ë³¸: ${formatFileSize(file.size)}<br>
                                    <span style="color: #999;">ë³€í™˜ ëŒ€ê¸°ì¤‘...</span>
                                </div>
                            </div>
                        `;
              imageGrid.appendChild(preview);
            };
            reader.readAsDataURL(file);
          });
        }
      }

      async function convertImages() {
        if (selectedFiles.length === 0) return;

        convertBtn.disabled = true;
        loading.style.display = 'block';
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';

        const formData = new FormData();
        selectedFiles.forEach((file) => {
          formData.append('images', file);
        });
        formData.append('quality', qualitySlider.value);

        try {
          const response = await fetch('/.netlify/functions/convert', {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            convertedFiles = result.files;
            displayConvertedImages(result.files);
            updateStats(result.files);
            successMessage.textContent = `âœ… ${result.files.length}ê°œì˜ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤!`;
            successMessage.style.display = 'block';
            downloadAllBtn.style.display = 'block';
          } else {
            throw new Error(result.error || 'ë³€í™˜ ì‹¤íŒ¨');
          }
        } catch (error) {
          console.error('Error:', error);
          errorMessage.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
          errorMessage.style.display = 'block';
        } finally {
          convertBtn.disabled = false;
          loading.style.display = 'none';
        }
      }

      function displayConvertedImages(files) {
        imageGrid.innerHTML = '';

        files.forEach((file) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';

          const reductionClass = file.reduction > 0 ? 'positive' : 'negative';

          imageItem.innerHTML = `
                    <img src="${file.url}" alt="${file.originalName}" class="image-preview">
                    <div class="image-info">
                        <div class="image-name" title="${file.originalName}">${file.originalName}</div>
                        <div class="image-sizes">
                            ì›ë³¸: ${formatFileSize(file.originalSize)}<br>
                            WebP: ${formatFileSize(file.convertedSize)}
                        </div>
                        <span class="size-reduction ${reductionClass}">
                            ${file.reduction > 0 ? 'â†“' : 'â†‘'} ${Math.abs(file.reduction)}%
                        </span>
                        <button class="download-btn" onclick="downloadFile('${file.url}', '${file.convertedName}')">
                            ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                `;

          imageGrid.appendChild(imageItem);
        });
      }

      function updateStats(files) {
        stats.style.display = 'block';

        const totalOriginal = files.reduce((sum, f) => sum + f.originalSize, 0);
        const totalConverted = files.reduce((sum, f) => sum + f.convertedSize, 0);
        const avgReduction = files.reduce((sum, f) => sum + f.reduction, 0) / files.length;

        document.getElementById('totalFiles').textContent = files.length;
        document.getElementById('totalOriginal').textContent = formatFileSize(totalOriginal);
        document.getElementById('totalConverted').textContent = formatFileSize(totalConverted);
        document.getElementById('totalSaved').textContent = Math.round(avgReduction) + '%';
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      }

      function downloadFile(url, filename) {
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
      }

      async function downloadAll() {
        if (convertedFiles.length === 0) return;

        try {
          const response = await fetch('/.netlify/functions/download-zip', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              files: convertedFiles.map((f) => f.convertedName),
            }),
          });

          if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'webp_images.zip';
            a.click();
            URL.revokeObjectURL(url);
          }
        } catch (error) {
          console.error('ZIP ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
          errorMessage.textContent = 'âŒ ZIP ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          errorMessage.style.display = 'block';
        }
      }
    </script>
  </body>
</html>
